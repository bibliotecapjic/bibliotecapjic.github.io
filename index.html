<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapas de Biblioteca</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; color: #333; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Header */
        .header { 
            background: linear-gradient(135deg, #2c3e50, #4a6491); 
            color: white; padding: 25px; border-radius: 10px; 
            margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { font-size: 28px; display: flex; align-items: center; gap: 12px; }
        .subtitle { font-size: 16px; opacity: 0.9; margin-top: 5px; }
        
        /* Main Content */
        .main-content { display: grid; grid-template-columns: 1fr 2fr; gap: 25px; }
        @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } }
        
        /* Controls Panel */
        .controls-panel { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        
        /* Biblioteca Section */
        .library-section { margin-bottom: 30px; }
        .section-title { 
            font-size: 18px; color: #2c3e50; margin-bottom: 15px; padding-bottom: 10px; 
            border-bottom: 2px solid #eee; display: flex; align-items: center; gap: 10px;
        }
        
        /* Library Buttons - REORGANIZADO */
        .library-buttons { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
        .library-btn { 
            padding: 16px; background: white; border: 2px solid #ddd; border-radius: 8px; 
            font-size: 16px; font-weight: 500; color: #555; cursor: pointer; transition: all 0.3s;
            text-align: left; display: flex; align-items: center; gap: 12px;
        }
        .library-btn:hover { border-color: #3498db; background: #f0f8ff; }
        .library-btn.selected { border-color: #3498db; background: #e3f2fd; color: #2c3e50; }
        .library-icon { font-size: 22px; width: 30px; }
        
        /* Divider */
        .divider {
            height: 1px;
            background: #e0e0e0;
            margin: 25px 0;
            width: 100%;
        }
        
        /* Signatura Section - REORGANIZADO */
        .signature-section { margin-bottom: 30px; }
        .signature-title { 
            font-size: 18px; color: #2c3e50; margin-bottom: 15px;
            display: flex; align-items: center; gap: 10px;
        }
        .required-field::after {
            content: " *";
            color: #e74c3c;
        }
        
        .signature-box { margin-top: 10px; }
        .signature-label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; font-size: 14px; }
        .signature-input { 
            width: 100%; padding: 16px; border: 2px solid #ddd; border-radius: 8px; 
            font-size: 16px; font-family: monospace; transition: all 0.3s;
        }
        .signature-input:required {
            border-left: 4px solid #3498db;
        }
        .signature-input:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 3px rgba(52,152,219,0.2); }
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
            line-height: 1.5;
        }
        
        /* Otros Materiales Section - REORGANIZADO */
        .other-materials-section { margin-bottom: 20px; }
        
        /* Material Buttons - MANTENIDO PERO REORGANIZADO */
        .material-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .material-btn { 
            padding: 14px 10px; background: white; border: 2px solid #ddd; border-radius: 6px; 
            font-size: 14px; font-weight: 500; color: #555; cursor: pointer; transition: all 0.3s;
        }
        .material-btn:hover { border-color: #f39c12; background: #fff9e6; }
        .material-btn.selected { border-color: #f39c12; background: #fff3cd; color: #856404; }
        
        /* Map Panel (NO MODIFICADO) */
        .map-panel { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
        
        /* Compact Selection Info */
        .selection-info { 
            background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; 
            border-left: 4px solid #3498db;
        }
        .selection-info h3 { 
            font-size: 16px; margin-bottom: 10px; color: #2c3e50; 
            display: flex; align-items: center; gap: 8px;
        }
        .selection-details { 
            display: flex; 
            flex-wrap: wrap;
            gap: 15px;
        }
        .detail-item { 
            flex: 1;
            min-width: 150px;
        }
        .detail-label { 
            font-size: 12px; 
            color: #666; 
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .detail-value { 
            font-size: 14px; 
            font-weight: 600; 
            color: #2c3e50;
            word-break: break-word;
        }
        
        /* Location Info Panel */
        .location-info-panel {
            background: #e8f6ef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #27ae60;
        }
        .location-info-panel.active {
            display: block;
        }
        .location-info-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .location-info-text {
            font-size: 14px;
            line-height: 1.6;
            color: #555;
        }
        
        /* Map Container */
        .map-container { 
            flex: 1; position: relative; background: #f8f9fa; border-radius: 8px; 
            overflow: hidden; border: 1px solid #e0e0e0; min-height: 500px;
            margin-bottom: 20px;
        }
        .initial-state { 
            display: flex; align-items: center; justify-content: center; height: 100%; 
            color: #999; font-size: 18px; text-align: center; padding: 40px;
        }
        .initial-state i { font-size: 48px; margin-bottom: 20px; opacity: 0.5; }
        
        /* Loading State */
        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #f8f9fa;
            color: #6c757d;
            font-size: 18px;
            text-align: center;
            padding: 40px;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Legend Panel */
        .legend-panel {
            background: white;
            padding: 12px 15px;
            border-radius: 6px;
            display: none;
            border: 1px solid #e0e0e0;
        }
        .legend-panel.active {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            background: rgba(255, 215, 0, 0.7);
            border: 2px solid #e67e22;
            border-radius: 2px;
            flex-shrink: 0;
        }
        .legend-text {
            font-size: 14px;
            color: #555;
        }
        
        /* No Map Available State */
        .no-map-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #6c757d;
            font-size: 18px;
            text-align: center;
            padding: 40px;
        }
        .no-map-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
            color: #adb5bd;
        }
        .no-map-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #495057;
        }
        .no-map-state p {
            font-size: 14px;
            opacity: 0.8;
            max-width: 400px;
            margin: 0 auto;
        }
        
        /* Message styles */
        .message { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .message-error { background: #fdecea; border-left: 4px solid #e74c3c; color: #c0392b; }
        .message-warning { background: #fff3cd; border-left: 4px solid #f39c12; color: #856404; }
        .message-success { background: #e8f6ef; border-left: 4px solid #27ae60; color: #27ae60; }
        
        /* For screen readers only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span aria-hidden="true">üó∫Ô∏è</span> Sistema de Mapas de Biblioteca</h1>
            <div class="subtitle">Selecciona la Biblioteca de tu inter√©s y localiza los materiales en el mapa de cada Biblioteca. Puede realizar la b√∫squeda mediante el c√≥digo de clasificaci√≥n (localizaci√≥n en estanter√≠a) o por tipo de material.</div>
        </div>
        
        <div class="main-content">
            <!-- Controls Panel - REORGANIZADO -->
            <div class="controls-panel">
                <!-- Biblioteca Section -->
                <div class="library-section">
                    <h2 class="section-title"><span aria-hidden="true">üèõÔ∏è</span> Biblioteca</h2>
                    <div class="library-buttons">
                        <button class="library-btn" id="btn-medellin" onclick="selectLibrary('medellin')"
                                aria-label="Seleccionar biblioteca de Medell√≠n">
                            <span class="library-icon" aria-hidden="true">üìö</span> Medell√≠n
                        </button>
                        <button class="library-btn" id="btn-oriente" onclick="selectLibrary('oriente')"
                                aria-label="Seleccionar Centro Regional Oriente">
                            <span class="library-icon" aria-hidden="true">üìö</span> Centro Regional Oriente
                        </button>
                        <button class="library-btn" id="btn-uraba" onclick="selectLibrary('uraba')"
                                aria-label="Seleccionar Centro Regional Urab√°">
                            <span class="library-icon" aria-hidden="true">üìö</span> Centro Regional Urab√°
                        </button>
                    </div>
                </div>
                
                <!-- Divider -->
                <div class="divider"></div>
                
                <!-- Signatura Section -->
                <div class="signature-section">
                    <h2 class="signature-title"><span aria-hidden="true">üî¢</span> <span class="required-field">Localizaci√≥n de Libros</span></h2>
                    <div class="signature-box">
                        <label class="signature-label" for="signature">Ingrese el n√∫mero que corresponde a la localizaci√≥n del libro en estanter√≠a:</label>
                        <input type="text" class="signature-input" id="signature" 
                               placeholder="123.4 A12 || 512.1 B18" 
                               aria-describedby="signature-help"
                               required>
                        <div id="signature-help" class="help-text">
                            Ingrese el n√∫mero de localizaci√≥n para ubicar el material en el mapa. Ejemplos: 658.403, 005.1, 900.2, A412, 312 A123.
                        </div>
                    </div>
                </div>
                
                <!-- Divider -->
                <div class="divider"></div>
                
                <!-- Otros Materiales Section -->
                <div class="other-materials-section">
                    <h2 class="section-title"><span aria-hidden="true">üìë</span> Otros Materiales</h2>
                    <div class="material-buttons">
                        <button class="material-btn" id="btn-tesis" onclick="selectMaterial('tesis')" aria-label="Buscar trabajo de grado">TRABAJO DE GRADO</button>
                        <button class="material-btn" id="btn-cd" onclick="selectMaterial('cd')" aria-label="Buscar CD">CD</button>
                        <button class="material-btn" id="btn-revista" onclick="selectMaterial('revista')" aria-label="Buscar revista">REVISTA</button>
                        <button class="material-btn" id="btn-folleto" onclick="selectMaterial('folleto')" aria-label="Buscar folleto">FOLLETO</button>
                        <button class="material-btn" id="btn-norma" onclick="selectMaterial('norma')" aria-label="Buscar norma">NORMA</button>
                    </div>
                </div>
            </div>
            
            <!-- Map Panel (NO MODIFICADO) -->
            <div class="map-panel">
                <!-- Messages -->
                <div class="message message-error" id="message-error" role="alert"></div>
                <div class="message message-warning" id="message-warning" role="alert"></div>
                <div class="message message-success" id="message-success" role="alert"></div>
                
                <!-- Compact Selection Info -->
                <div class="selection-info" id="selection-info" style="display: none;">
                    <h3><span aria-hidden="true">üìã</span> Selecci√≥n Actual</h3>
                    <div class="selection-details">
                        <div class="detail-item">
                            <div class="detail-label">Biblioteca:</div>
                            <div class="detail-value" id="current-library">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Tipo de material:</div>
                            <div class="detail-value" id="current-material">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Localizaci√≥n:</div>
                            <div class="detail-value" id="current-signature">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Info Panel -->
                <div class="location-info-panel" id="location-info-panel">
                    <div class="location-info-title"><span aria-hidden="true">üìç</span> Informaci√≥n de Ubicaci√≥n</div>
                    <div class="location-info-text" id="location-info-text">Seleccione una biblioteca e ingrese el n√∫mero de localizaci√≥n para ubicarlo en el mapa</div>
                </div>
                
                <!-- Map Container -->
                <div class="map-container" id="map-container">
                    <div class="initial-state" id="initial-state">
                        <div>
                            <span aria-hidden="true">üó∫Ô∏è</span>
                            <p>Seleccione una biblioteca e ingrese el n√∫mero de localizaci√≥n para ubicarlo en el mapa</p>
                        </div>
                    </div>
                </div>
                
                <!-- Legend Panel -->
                <div class="legend-panel" id="legend-panel">
                    <div class="legend-color"></div>
                    <div class="legend-text">Ubicaci√≥n aproximada del material</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables de estado
        let selectedLibrary = null;
        let selectedMaterial = null;
        let currentLibraryData = null;
        let searchTimeout = null;
        let currentImageLoadTimeout = null;
        let isMapLoading = false;
        
        // Configuraci√≥n de mapas
        const mapData = {
            "MEDELL√çN": {
                name: "Biblioteca Medell√≠n",
                floors: {
                    1: {
                        img: "images/mapa-medellin-piso-1.png",
                        staticLocations: {
                            "REVISTA": {
                                x: 0.0815, y: 0.8564, width: 0.1046, height: 0.0799,
                                message: "Colecci√≥n de Revistas - Hemeroteca",
                            },
                            "FOLLETO": {
                                x: 0.08167, y: 0.2153, width: 0.1046, height: 0.2088,
                                message: "Colecci√≥n de Folletos. Consultar en Circulaci√≥n y Pr√©stamo",
                            },
                            "TRABAJO DE GRADO": [
                                {
                                    x: 0.08167, y: 0.2153, width: 0.1046, height: 0.2088,
                                    message: "Colecci√≥n de trabajos de grado (TDG). Tener presente que los TDG en formato f√≠sico se encuentran en el piso 2 de la Biblioteca. Los TDG en CDs se encuentran en el primer piso - Circulaci√≥n y pr√©stamo",
                                },
                                {
                                    x: 0.8167, y: 0.4356, width: 0.1694, height: 0.2643,
                                    message: "DVDs y material audiovisual",
                                }
                            ],
                            "NORMAS": {
                                x: 0.08167, y: 0.2153, width: 0.1046, height: 0.2088,
                                message: "Colecci√≥n de Normas T√©cnicas. Consultar en Circulaci√≥n y Pr√©stamo",
                            },
                            "MULTIMEDIA": {
                                x: 0.08167, y: 0.2153, width: 0.1046, height: 0.2088,
                                message: "Colecci√≥n Multimedia - CDs, DVDs. Consultar en Circulaci√≥n y Pr√©stamo",
                            }
                        },
                        stacks: [
                            { id: "1.1A1.Izquierdo", start: "000.0", end: "005.1", x: 0.6222, y: 0.6770, height: 0.1109, width: 0.0269 },
                            { id: "1.1A2.Izquierdo", start: "005.101", end: "036.0", x: 0.6222, y: 0.8254, height: 0.1109, width: 0.0269 },
                            { id: "1.1B2.Derecho", start: "036.01", end: "302.0", x: 0.5944, y: 0.8254, height: 0.1109, width: 0.0269 },
                            { id: "1.1B1.Derecho", start: "302.01", end: "330.01", x: 0.5944, y: 0.6770, height: 0.1109, width: 0.0269 },
                            { id: "1.2A1.Izquierdo", start: "330.011", end: "338.5", x: 0.5602, y: 0.6770, height: 0.1109, width: 0.0269 },
                            { id: "1.2A2.Izquierdo", start: "338.501", end: "373.2", x: 0.5602, y: 0.8254, height: 0.1109, width: 0.0269 },
                            { id: "1.2B2.Derecho", start: "373.201", end: "512.1", x: 0.5324, y: 0.8254, height: 0.1109, width: 0.0269 },
                            { id: "1.2B1.Derecho", start: "512.101", end: "515.3", x: 0.5324, y: 0.6770, height: 0.1109, width: 0.0269 },
                            { id: "1.3A1.Izquierdo", start: "515.301", end: "519.5", x: 0.4963, y: 0.6770, height: 0.1109, width: 0.0269 },
                            { id: "1.3A2.Izquierdo", start: "519.501", end: "537.0", x: 0.4936, y: 0.8254, height: 0.1109, width: 0.0269 },
                            { id: "1.3B2.Derecho", start: "537.01", end: "574.5", x: 0.4685, y: 0.8254, height: 0.1109, width: 0.0269 },
                            { id: "1.3B1.Derecho", start: "574.501", end: "591.0", x: 0.4685, y: 0.6770, height: 0.1109, width: 0.0269 },
                            { id: "1.4A1.Izquierdo", start: "591.01", end: "612.76", x: 0.4324, y: 0.6770, height: 0.1109, width: 0.0269 },
                            { id: "1.4A2.Izquierdo", start: "612.7601", end: "612.27", x: 0.4333, y: 0.8254, height: 0.1109, width: 0.0269 },
                            { id: "1.4B2.Derecho", start: "612.2701", end: "621.4", x: 0.4065, y: 0.8254, height: 0.1109, width: 0.0269 },
                            { id: "1.4B1.Derecho", start: "621.401", end: "624.18", x: 0.4065, y: 0.6770, height: 0.1109, width: 0.0269 },
                            { id: "1.5A1.Izquierdo", start: "624.1801", end: "629.8", x: 0.3713, y: 0.6770, height: 0.1109, width: 0.0269 },
                            { id: "1.5A2.Izquierdo", start: "629.801", end: "634.0", x: 0.3704, y: 0.8254, height: 0.1109, width: 0.0269 },
                            { id: "1.5B2.Derecho", start: "634.01", end: "657.0", x: 0.3435, y: 0.8254, height: 0.1109, width: 0.0269 },
                            { id: "1.5B1.Derecho", start: "657.01", end: "657.8", x: 0.3435, y: 0.6770, height: 0.1109, width: 0.0269 },
                            { id: "1.6A1.Izquierdo", start: "657.801", end: "658.3", x: 0.3074, y: 0.6770, height: 0.1109, width: 0.0269 },
                            { id: "1.6A2.Izquierdo", start: "658.301", end: "658.5", x: 0.3074, y: 0.8254, height: 0.1109, width: 0.0269 },
                            { id: "1.6B2.Derecho", start: "658.501", end: "658.85", x: 0.2806, y: 0.8254, height: 0.1109, width: 0.0269 },
                            { id: "1.6B1.Derecho", start: "658.8501", end: "690.2", x: 0.2806, y: 0.6770, height: 0.1109, width: 0.0269 },
                            { id: "1.7A1.Izquierdo", start: "690.201", end: "790.2", x: 0.2444, y: 0.6770, height: 0.1109, width: 0.0269 },
                            { id: "1.7A2.Izquierdo", start: "790.201", end: "799.1", x: 0.2444, y: 0.8254, height: 0.1109, width: 0.0269 },
                            { id: "1.7B2.Derecho", start: "799.101", end: "899.9", x: 0.2185, y: 0.8254, height: 0.1109, width: 0.0269 },
                            { id: "1.7B1.Derecho", start: "900", end: "999.9", x: 0.2185, y: 0.6770, height: 0.1109, width: 0.0269 }
                        ],
                    },
                    2: {
                        img: "images/mapa-medellin-piso-2.png",
                        staticLocations: {
                            "COLECCION ESTATICA": {
                                x:0.0, y:0.0, width:0.0, height:0.0,
                                message: "Colecci√≥n - Piso 2",
                            }
                        },
                        stacks: [],
                    },
                },
            },
            "CENTRO REGIONAL ORIENTE": {
                name: "Biblioteca Centro Regional Oriente",
                floors: {
                    1: {
                        img: "https://bibliotecapjic.github.io/images/mapa-oriente-piso-1.png",
                        staticLocations: {
                            "REVISTA": {
                                x: 0.2, y: 0.3, width: 0.1, height: 0.1,
                                message: "Colecci√≥n de Revistas - Oriente",
                            },
                            "TRABAJO DE GRADO": {
                                x: 0.4, y: 0.5, width: 0.1, height: 0.1,
                                message: "Colecci√≥n de Tesis - Oriente",
                            }
                        },
                        stacks: [],
                    }
                },
            },
            "CENTRO REGIONAL URAB√Å": {
                name: "Biblioteca Centro Regional Urab√°",
                floors: {
                    1: {
                        img: "https://bibliotecapjic.github.io/images/mapa-uraba-piso-1.png",
                        staticLocations: {
                            "REVISTA": {
                                x: 0.2, y: 0.3, width: 0.1, height: 0.1,
                                message: "Colecci√≥n de Revistas - Urab√°",
                            }
                        },
                        stacks: [],
                    }
                },
            }
        };

        // Mapeo de selecciones a valores del sistema
        const libraryMap = {
            'medellin': 'MEDELL√çN',
            'oriente': 'CENTRO REGIONAL ORIENTE',
            'uraba': 'CENTRO REGIONAL URAB√Å'
        };
        
        const materialMap = {
            'tesis': 'TRABAJO DE GRADO',
            'cd': 'MULTIMEDIA',
            'revista': 'REVISTA',
            'folleto': 'FOLLETO',
            'norma': 'NORMAS'
        };
        
        const materialDisplayNames = {
            'tesis': 'TRABAJO DE GRADO',
            'cd': 'CD',
            'revista': 'REVISTA',
            'folleto': 'FOLLETO',
            'norma': 'NORMA'
        };

        // FUNCI√ìN MEJORADA: Normalizar n√∫meros Dewey
        function normalizeDewey(callNumber) {
            if (!callNumber) return null;
            
            try {
                const original = callNumber.toString().trim();
                console.log(`üîç Normalizando signatura: "${original}"`);
                
                let match = original.match(/^[A-Z]*(\d+(?:\.\d+)?)/);
                
                if (!match) {
                    match = original.match(/^(\d+(?:\.\d+)?)/);
                }
                
                if (!match) {
                    console.log(`‚ùå No se pudo extraer parte num√©rica de: "${original}"`);
                    return null;
                }
                
                const numericPart = match[1];
                const numericValue = parseFloat(numericPart);
                
                console.log(`‚úÖ Signatura "${original}" ‚Üí Parte num√©rica: "${numericPart}" ‚Üí Valor: ${numericValue}`);
                
                return {
                    original: original,
                    numericPart: numericValue,
                    fullMatch: match[0],
                    normalized: numericPart
                };
            } catch (e) {
                console.error("‚ùå Error normalizando Dewey:", e, callNumber);
                return null;
            }
        }
        
        function validateSignature(signature) {
            const safePattern = /^[0-9A-Za-z.,\s-]+$/;
            if (!safePattern.test(signature)) {
                console.log(`‚ùå Signatura no v√°lida (patr√≥n): "${signature}"`);
                return false;
            }
            
            if (signature.length > 50) {
                console.log(`‚ùå Signatura demasiado larga: "${signature}"`);
                return false;
            }
            
            console.log(`‚úÖ Signatura v√°lida: "${signature}"`);
            return true;
        }
        
        function searchInStacks(libraryMapData, callNumber) {
            if (!callNumber) {
                console.log("‚ö†Ô∏è No hay signatura para buscar");
                return null;
            }
            
            console.log(`üîç Buscando en estantes: "${callNumber}"`);
            let callNumNormalized = normalizeDewey(callNumber);
            
            if (callNumNormalized && !isNaN(callNumNormalized.numericPart)) {
                console.log(`üìä Valor num√©rico para b√∫squeda: ${callNumNormalized.numericPart}`);
                
                for (let floorNum in libraryMapData.floors) {
                    let floor = libraryMapData.floors[floorNum];
                    if (floor.stacks && floor.stacks.length > 0) {
                        console.log(`üìö Revisando piso ${floorNum} con ${floor.stacks.length} estantes`);
                        
                        for (let j = 0; j < floor.stacks.length; j++) {
                            let stack = floor.stacks[j];
                            try {
                                let startNormalized = normalizeDewey(stack.start);
                                let endNormalized = normalizeDewey(stack.end);
                                
                                if (startNormalized && endNormalized) {
                                    console.log(`üìñ Estante ${stack.id}: ${startNormalized.numericPart} - ${endNormalized.numericPart}`);
                                    
                                    if (callNumNormalized.numericPart >= startNormalized.numericPart && 
                                        callNumNormalized.numericPart <= endNormalized.numericPart) {
                                        
                                        console.log(`‚úÖ ENCONTRADO en estante: ${stack.id}`);
                                        
                                        return {
                                            floor: floorNum,
                                            x: stack.x,
                                            y: stack.y,
                                            width: stack.width,
                                            height: stack.height,
                                            stackInfo: stack.id
                                        };
                                    }
                                }
                            } catch (e) {
                                console.error("‚ùå Error en comparaci√≥n Dewey:", e);
                            }
                        }
                    }
                }
            } else {
                console.log(`‚ùå No se pudo normalizar o valor no num√©rico: "${callNumber}"`);
            }
            
            console.log(`‚ùå No encontrado en estantes: "${callNumber}"`);
            return null;
        }
        
        function searchInStaticLocations(libraryMapData, locationType) {
            console.log(`üîç Buscando ubicaci√≥n est√°tica: "${locationType}"`);
            
            for (let floorNum in libraryMapData.floors) {
                let floor = libraryMapData.floors[floorNum];
                if (floor.staticLocations && floor.staticLocations[locationType]) {
                    let staticLoc = floor.staticLocations[locationType];
                    
                    console.log(`‚úÖ Encontrada ubicaci√≥n est√°tica en piso ${floorNum}`);
                    
                    if (Array.isArray(staticLoc)) {
                        return {
                            floor: floorNum,
                            locations: staticLoc,
                            isMultiple: true
                        };
                    } else if (typeof staticLoc === 'object') {
                        return {
                            floor: floorNum,
                            x: staticLoc.x,
                            y: staticLoc.y,
                            width: staticLoc.width,
                            height: staticLoc.height,
                            message: staticLoc.message,
                            isMultiple: false
                        };
                    }
                }
            }
            
            console.log(`‚ùå No encontrada ubicaci√≥n est√°tica: "${locationType}"`);
            return null;
        }

        // FUNCI√ìN CORREGIDA: Cargar mapa de biblioteca
        function loadLibraryMap(libraryKey) {
            console.log(`üîÑ CARGANDO MAPA para: ${libraryKey}`);
            
            if (isMapLoading) {
                console.log(`‚è≥ Ya se est√° cargando un mapa, esperando...`);
                return false;
            }
            
            isMapLoading = true;
            
            if (currentImageLoadTimeout) {
                clearTimeout(currentImageLoadTimeout);
                currentImageLoadTimeout = null;
            }
            
            const libraryData = mapData[libraryKey];
            if (!libraryData) {
                console.error(`‚ùå No hay datos para: ${libraryKey}`);
                showNoMapAvailable("No se encontraron datos para esta biblioteca");
                isMapLoading = false;
                return false;
            }
            
            currentLibraryData = libraryData;
            
            const mapContainer = document.getElementById('map-container');
            
            // Limpiar el contenedor
            mapContainer.innerHTML = '';
            
            // Mostrar estado de carga
            mapContainer.innerHTML = `
                <div class="loading-state" id="current-loading-state">
                    <div>
                        <div class="loading-spinner"></div>
                        <p>Cargando mapa de ${libraryData.name}...</p>
                    </div>
                </div>
            `;
            
            // Cargar la imagen
            const floorData = libraryData.floors[1];
            const imgPath = floorData.img;
            
            console.log(`üìÅ Intentando cargar imagen: ${imgPath}`);
            
            const img = new Image();
            
            currentImageLoadTimeout = setTimeout(() => {
                console.log(`‚è∞ Timeout: La imagen ${imgPath} est√° tardando demasiado`);
                if (img && !img.complete) {
                    img.onload = null;
                    img.onerror = null;
                    showNoMapAvailable(`El mapa no se pudo cargar. Tiempo de espera agotado.`);
                }
                currentImageLoadTimeout = null;
                isMapLoading = false;
            }, 5000);
            
            img.onload = function() {
                console.log(`‚úÖ Imagen cargada exitosamente: ${imgPath}`);
                
                if (currentImageLoadTimeout) {
                    clearTimeout(currentImageLoadTimeout);
                    currentImageLoadTimeout = null;
                }
                
                const imgElement = document.createElement('img');
                imgElement.id = 'map-image';
                imgElement.src = imgPath;
                imgElement.alt = `Mapa de ${libraryData.name}`;
                imgElement.style.width = '100%';
                imgElement.style.height = '100%';
                imgElement.style.objectFit = 'contain';
                
                mapContainer.innerHTML = '';
                mapContainer.appendChild(imgElement);
                clearMapMarkers();
                
                imgElement.onload = function() {
                    console.log(`‚úÖ Imagen renderizada en DOM: ${libraryData.name}`);
                    isMapLoading = false;
                    
                    // Si hay signatura ingresada, buscar ubicaci√≥n
                    const signature = document.getElementById('signature').value.trim();
                    if (signature) {
                        setTimeout(() => {
                            findAndDisplayLocation();
                        }, 100);
                    }
                };
                
                imgElement.onerror = function() {
                    console.error(`‚ùå Error renderizando imagen en DOM: ${imgPath}`);
                    showNoMapAvailable(`Error al mostrar el mapa de ${libraryData.name}`);
                    isMapLoading = false;
                };
            };
            
            img.onerror = function() {
                console.error(`‚ùå Error cargando imagen: ${imgPath}`);
                
                if (currentImageLoadTimeout) {
                    clearTimeout(currentImageLoadTimeout);
                    currentImageLoadTimeout = null;
                }
                
                showNoMapAvailable(`No se pudo cargar el mapa de ${libraryData.name}.`);
                isMapLoading = false;
                return false;
            };
            
            img.src = imgPath;
            
            return true;
        }

        // FUNCI√ìN MEJORADA: Mostrar estado "mapa no disponible"
        function showNoMapAvailable(message = "El mapa para esta selecci√≥n no est√° disponible en el sistema.") {
            const mapContainer = document.getElementById('map-container');
            
            if (currentImageLoadTimeout) {
                clearTimeout(currentImageLoadTimeout);
                currentImageLoadTimeout = null;
            }
            
            mapContainer.innerHTML = `
                <div class="no-map-state">
                    <div>
                        <span aria-hidden="true">üö´</span>
                        <h3>Mapa no disponible</h3>
                        <p>${message}</p>
                        <p style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                            Seleccione otra biblioteca o consulte con el personal de la biblioteca.
                        </p>
                    </div>
                </div>
            `;
            
            clearMapMarkers();
            document.getElementById('location-info-panel').classList.remove('active');
            document.getElementById('legend-panel').classList.remove('active');
        }

        // FUNCI√ìN CORREGIDA: Buscar y mostrar ubicaci√≥n
        function findAndDisplayLocation() {
            if (!selectedLibrary) {
                console.log("‚ùå No hay biblioteca seleccionada");
                return;
            }
            
            const signature = document.getElementById('signature').value.trim();
            if (!signature) {
                console.log("‚ùå No hay signatura ingresada");
                return;
            }
            
            const libraryKey = libraryMap[selectedLibrary];
            const libraryData = mapData[libraryKey];
            
            if (!libraryData) {
                console.error("‚ùå No hay datos para la biblioteca:", libraryKey);
                return;
            }
            
            // Verificar que el mapa est√© cargado
            const mapContainer = document.getElementById('map-container');
            const mapImage = mapContainer.querySelector('img#map-image');
            const noMapState = mapContainer.querySelector('.no-map-state');
            
            if (noMapState) {
                console.log("‚èπÔ∏è Ya se mostr√≥ que no hay mapa disponible, deteniendo b√∫squeda");
                return;
            }
            
            if (!mapImage) {
                console.log("‚ö†Ô∏è El mapa no est√° cargado. Mostrando mensaje informativo.");
                
                const locationInfoPanel = document.getElementById('location-info-panel');
                const locationInfoText = document.getElementById('location-info-text');
                
                locationInfoText.textContent = `Material disponible en ${libraryData.name}. Seleccione primero una biblioteca para ver el mapa.`;
                locationInfoPanel.classList.add('active');
                return;
            }
            
            console.log(`üîç Buscando ubicaci√≥n en ${libraryData.name} para signatura: ${signature}`);
            
            // Validar la signatura
            if (!validateSignature(signature)) {
                const locationInfoPanel = document.getElementById('location-info-panel');
                const locationInfoText = document.getElementById('location-info-text');
                locationInfoText.textContent = `Signatura no v√°lida. Por favor ingrese una signatura v√°lida.`;
                locationInfoPanel.classList.add('active');
                clearMapMarkers();
                return;
            }
            
            // Buscar en los estantes (para libros)
            const locationResult = searchInStacks(libraryData, signature);
            let locationMessage;
            
            if (locationResult) {
                const parts = locationResult.stackInfo.split('.');
                locationMessage = `Este material puede encontrarse en el piso ${locationResult.floor} de la ${libraryData.name}, estante ${parts[1]} lado ${parts[2]}. Esta es una referencia aproximada.`;
                console.log(`‚úÖ Ubicaci√≥n encontrada: ${locationMessage}`);
            } else {
                locationMessage = `Material disponible en ${libraryData.name} (Colecci√≥n General). Consulte con el personal para ubicaci√≥n exacta.`;
                console.log(`‚ÑπÔ∏è Ubicaci√≥n general: ${locationMessage}`);
            }
            
            if (locationResult) {
                drawLocation(locationResult);
                showLocationInfo(locationMessage);
            } else {
                clearMapMarkers();
                showLocationInfo(locationMessage);
            }
        }
        
        function selectLibrary(libraryId) {
            console.log(`üéØ SELECT LIBRARY llamado con: ${libraryId}`);
            
            if (selectedLibrary === libraryId) {
                console.log(`üìå Ya est√° seleccionada: ${libraryId}`);
                return;
            }
            
            if (selectedLibrary) {
                document.getElementById(`btn-${selectedLibrary}`).classList.remove('selected');
            }
            
            selectedLibrary = libraryId;
            document.getElementById(`btn-${libraryId}`).classList.add('selected');
            
            // Resetear estado de carga
            isMapLoading = false;
            
            // Cargar el mapa
            const libraryKey = libraryMap[libraryId];
            console.log(`üó∫Ô∏è Cargando mapa para clave: ${libraryKey}`);
            
            if (libraryKey) {
                loadLibraryMap(libraryKey);
            }
            
            updateUI();
        }
        
        function selectMaterial(materialId) {
            console.log(`üìë SELECT MATERIAL llamado con: ${materialId}`);
            
            if (selectedMaterial) {
                document.getElementById(`btn-${selectedMaterial}`).classList.remove('selected');
            }
            selectedMaterial = materialId;
            document.getElementById(`btn-${materialId}`).classList.add('selected');
            
            // AJUSTE: Borrar signatura si hay datos en el campo
            const signatureInput = document.getElementById('signature');
            if (signatureInput.value.trim()) {
                console.log(`üßπ Borrando signatura porque se seleccion√≥: ${materialId}`);
                signatureInput.value = '';
            }
            
            updateUI();
            
            // Si hay biblioteca seleccionada, buscar ubicaci√≥n para este material
            if (selectedLibrary) {
                console.log(`üîç Buscando ubicaci√≥n para material: ${materialId}`);
                findAndDisplayLocationForMaterial(materialId);
            } else {
                console.log("‚ö†Ô∏è No hay biblioteca seleccionada, no se puede buscar ubicaci√≥n");
            }
        }
        
        function findAndDisplayLocationForMaterial(materialId) {
            if (!selectedLibrary) {
                console.log("‚ùå No hay biblioteca seleccionada");
                return;
            }
            
            const libraryKey = libraryMap[selectedLibrary];
            const locationType = materialMap[materialId];
            const libraryData = mapData[libraryKey];
            
            if (!libraryData) {
                console.error("‚ùå No hay datos para la biblioteca:", libraryKey);
                return;
            }
            
            // Verificar que el mapa est√© cargado
            const mapContainer = document.getElementById('map-container');
            const mapImage = mapContainer.querySelector('img#map-image');
            const noMapState = mapContainer.querySelector('.no-map-state');
            
            if (noMapState) {
                console.log("‚èπÔ∏è Ya se mostr√≥ que no hay mapa disponible, deteniendo b√∫squeda");
                return;
            }
            
            if (!mapImage) {
                console.log("‚ö†Ô∏è El mapa no est√° cargado.");
                return;
            }
            
            console.log(`üîç Buscando ubicaci√≥n en ${libraryData.name} para: ${locationType}`);
            
            const locationResult = searchInStaticLocations(libraryData, locationType);
            let locationMessage;
            
            if (locationResult) {
                if (locationResult.isMultiple) {
                    locationMessage = locationResult.locations[0].message;
                } else {
                    locationMessage = locationResult.message;
                }
                console.log(`‚úÖ Ubicaci√≥n est√°tica encontrada: ${locationMessage}`);
            } else {
                locationMessage = `Material disponible en ${libraryData.name} (${materialDisplayNames[materialId]}). Consulte con el personal para ubicaci√≥n exacta.`;
                console.log(`‚ÑπÔ∏è Ubicaci√≥n general: ${locationMessage}`);
            }
            
            if (locationResult) {
                drawLocation(locationResult);
                showLocationInfo(locationMessage);
            } else {
                clearMapMarkers();
                showLocationInfo(locationMessage);
            }
        }
        
        function updateUI() {
            const signature = document.getElementById('signature');
            const signatureValue = signature.value.trim();
            
            // El campo de signatura siempre est√° habilitado
            signature.disabled = false;
            signature.setAttribute('required', 'required');
            signature.placeholder = "123.4 A12 || 512.1 B18";
            
            // Actualizar informaci√≥n de selecci√≥n
            if (selectedLibrary || selectedMaterial || signatureValue) {
                document.getElementById('selection-info').style.display = 'block';
                document.getElementById('current-library').textContent = selectedLibrary ? 
                    libraryMap[selectedLibrary] : '-';
                document.getElementById('current-material').textContent = selectedMaterial ? 
                    materialDisplayNames[selectedMaterial] : 'LIBRO';
                document.getElementById('current-signature').textContent = signatureValue || '-';
            } else {
                document.getElementById('selection-info').style.display = 'none';
            }
        }
        
        function showLocationInfo(locationMessage) {
            const locationInfoPanel = document.getElementById('location-info-panel');
            const locationInfoText = document.getElementById('location-info-text');
            
            locationInfoText.textContent = locationMessage;
            locationInfoPanel.classList.add('active');
            document.getElementById('legend-panel').classList.add('active');
        }
        
        function drawLocation(locationResult) {
            const mapContainer = document.getElementById('map-container');
            
            clearMapMarkers();
            
            if (locationResult) {
                if (locationResult.isMultiple && locationResult.locations) {
                    locationResult.locations.forEach((loc, index) => {
                        const marker = createMarker(loc.x, loc.y, loc.width, loc.height, index);
                        mapContainer.appendChild(marker);
                    });
                } else if (!locationResult.isMultiple && locationResult.x !== undefined) {
                    const marker = createMarker(locationResult.x, locationResult.y, locationResult.width, locationResult.height);
                    mapContainer.appendChild(marker);
                }
                
                setTimeout(adjustMarkersPosition, 100);
            }
        }
        
        function createMarker(x, y, width, height, index = 0) {
            const marker = document.createElement('div');
            marker.className = 'map-marker';
            marker.setAttribute('data-relative-x', x);
            marker.setAttribute('data-relative-y', y);
            marker.setAttribute('data-relative-width', width);
            marker.setAttribute('data-relative-height', height);
            marker.style.position = 'absolute';
            marker.style.background = 'rgba(255, 215, 0, 0.7)';
            marker.style.border = '2px solid #e67e22';
            marker.style.pointerEvents = 'none';
            marker.style.boxSizing = 'border-box';
            marker.style.borderRadius = '4px';
            marker.style.boxShadow = '0 0 15px rgba(230, 126, 34, 0.8)';
            marker.style.zIndex = '10';
            marker.style.display = 'none';
            
            const markerIcon = document.createElement('div');
            markerIcon.style.color = '#2c3e50';
            markerIcon.style.fontWeight = 'bold';
            markerIcon.style.textAlign = 'center';
            markerIcon.style.position = 'absolute';
            markerIcon.style.top = '50%';
            markerIcon.style.left = '50%';
            markerIcon.style.transform = 'translate(-50%, -50%)';
            markerIcon.style.fontSize = index > 0 ? '20px' : '24px';
            markerIcon.style.textShadow = '2px 2px 4px rgba(0,0,0,0.3)';
            markerIcon.style.zIndex = '11';
            markerIcon.textContent = 'üìç';
            markerIcon.setAttribute('aria-hidden', 'true');
            
            marker.appendChild(markerIcon);
            
            return marker;
        }
        
        function adjustMarkersPosition() {
            const mapContainer = document.getElementById('map-container');
            const mapImage = mapContainer.querySelector('img#map-image');
            const markers = mapContainer.querySelectorAll('.map-marker');
            
            if (!mapImage || markers.length === 0) return;
            
            if (mapImage.naturalWidth === 0 || mapImage.naturalHeight === 0) {
                setTimeout(adjustMarkersPosition, 100);
                return;
            }
            
            const containerWidth = mapContainer.clientWidth;
            const containerHeight = mapContainer.clientHeight;
            const naturalWidth = mapImage.naturalWidth;
            const naturalHeight = mapImage.naturalHeight;
            
            const containerAspectRatio = containerWidth / containerHeight;
            const imageAspectRatio = naturalWidth / naturalHeight;
            
            let displayWidth, displayHeight, offsetX, offsetY;
            
            if (containerAspectRatio > imageAspectRatio) {
                displayHeight = containerHeight;
                displayWidth = naturalWidth * (containerHeight / naturalHeight);
                offsetX = (containerWidth - displayWidth) / 2;
                offsetY = 0;
            } else {
                displayWidth = containerWidth;
                displayHeight = naturalHeight * (containerWidth / naturalWidth);
                offsetX = 0;
                offsetY = (containerHeight - displayHeight) / 2;
            }
            
            markers.forEach(marker => {
                const relX = parseFloat(marker.getAttribute('data-relative-x'));
                const relY = parseFloat(marker.getAttribute('data-relative-y'));
                const relWidth = parseFloat(marker.getAttribute('data-relative-width'));
                const relHeight = parseFloat(marker.getAttribute('data-relative-height'));
                
                const markerLeft = offsetX + (relX * displayWidth);
                const markerTop = offsetY + (relY * displayHeight);
                const markerWidth = relWidth * displayWidth;
                const markerHeight = relHeight * displayHeight;
                
                marker.style.left = `${markerLeft}px`;
                marker.style.top = `${markerTop}px`;
                marker.style.width = `${markerWidth}px`;
                marker.style.height = `${markerHeight}px`;
                marker.style.display = 'block';
            });
        }
        
        function clearMapMarkers() {
            const mapContainer = document.getElementById('map-container');
            const markers = mapContainer.querySelectorAll('.map-marker');
            markers.forEach(marker => marker.remove());
        }
        
        // Redimensionamiento
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                if (selectedLibrary) {
                    adjustMarkersPosition();
                }
            }, 250);
        });
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            const signatureInput = document.getElementById('signature');
            
            // Cargar mapa de Centro Regional Oriente por defecto
           
            if (libraryKey) {
                loadLibraryMap(libraryKey);
            }
            
            signatureInput.addEventListener('input', function() {
                updateUI();
                
                if (selectedLibrary) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        findAndDisplayLocation();
                    }, 500);
                }
            });
            
            signatureInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    clearTimeout(searchTimeout);
                    if (selectedLibrary) {
                        findAndDisplayLocation();
                    }
                }
            });
            
            updateUI();
            console.log('‚úÖ Sistema inicializado - Ajuste aplicado: se borra signatura al seleccionar otros materiales');
        });
    </script>
</body>
</html>
